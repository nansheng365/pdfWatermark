<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF水印处理器</title>
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <!-- 添加PDF.js库 https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js-->
    <script src="./js/pdf.min.js"></script>
    <style>
        /* 添加PDF转图片相关的样式 */
        .pdf-to-image-section {
            margin-top: 30px;
            padding: 20px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            background-color: #f8f9fa;
        }

        .pdf-preview-container {
            margin-top: 20px;
            text-align: center;
        }

        .pdf-preview-image {
            max-width: 100%;
            max-height: 600px;
            border: 1px solid #ddd;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .hidden {
            display: none;
        }

        /* ========== 核心：缩小版美化滑块（尺寸减半） ========== */
        .custom-range {
            height: 1rem;
            /* 原2rem → 缩小为1rem */
            padding: 0;
            --bs-range-track-bg: #dee2e6;
            --bs-range-thumb-bg: #0d6efd;
            --bs-range-thumb-hover-bg: #0a58ca;
        }

        /* WebKit内核（Chrome/Safari/Edge） */
        .custom-range::-webkit-slider-runnable-track {
            height: 6px;
            /* 原12px → 缩小为6px */
            border-radius: 3px;
            /* 原6px → 缩小为3px（比例一致） */
            background: var(--bs-range-track-bg);
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1);
            /* 阴影轻微缩小，更协调 */
        }

        .custom-range::-webkit-slider-thumb {
            width: 12px;
            /* 原24px → 缩小为12px */
            height: 12px;
            /* 原24px → 缩小为12px */
            margin-top: -3px;
            /* 原-6px → 缩小为-3px（轨道6px，滑块12px，垂直居中） */
            border-radius: 50%;
            background: var(--bs-range-thumb-bg);
            border: none;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            /* 阴影同步缩小 */
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .custom-range::-webkit-slider-thumb:hover {
            background: var(--bs-range-thumb-hover-bg);
            transform: scale(1.1);
            /* 保留hover放大效果，比例不变 */
        }

        .custom-range:focus::-webkit-slider-thumb {
            box-shadow: 0 0 0 4px rgba(13, 110, 253, 0.25);
            /* 原8px → 缩小为4px */
        }

        /* Firefox适配 */
        .custom-range::-moz-range-track {
            height: 6px;
            /* 原12px → 6px */
            border-radius: 3px;
            /* 原6px → 3px */
            background: var(--bs-range-track-bg);
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1);
            border: none;
        }

        .custom-range::-moz-range-thumb {
            width: 12px;
            /* 原24px → 12px */
            height: 12px;
            /* 原24px → 12px */
            border-radius: 50%;
            background: var(--bs-range-thumb-bg);
            border: none;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .custom-range::-moz-range-thumb:hover {
            background: var(--bs-range-thumb-hover-bg);
            transform: scale(1.1);
        }

        .custom-range:focus::-moz-range-thumb {
            box-shadow: 0 0 0 4px rgba(13, 110, 253, 0.25);
            /* 原8px → 4px */
        }
    </style>
</head>

<body>
    <div class="container mt-5">
        <h1 class="mb-4">PDF水印处理器</h1>

        <!-- 文件上传区域 -->
        <div class="card mb-4">
            <div class="card-header">
                <h5>上传PDF文件</h5>
            </div>
            <div class="card-body">
                <form id="uploadForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="pdfFile" class="form-label">选择PDF文件</label>
                        <input class="form-control" type="file" id="pdfFile" name="pdfFile" accept=".pdf" required>
                    </div>
                    <button type="submit" class="btn btn-primary">上传文件</button>
                </form>
            </div>
        </div>

        <!-- 文件列表区域 -->
        <div class="card mb-4">
            <div class="card-header">
                <h5>已上传文件</h5>
            </div>
            <div class="card-body">
                <div id="fileList">
                    <p>正在加载文件列表...</p>
                </div>
            </div>
        </div>

        <!-- PDF转首页图片区域 -->
        <div class="card mb-4 pdf-to-image-section">
            <div class="card-header">
                <h5>PDF首页转图片</h5>
            </div>
            <div class="card-body">
                <div class="border p-3 mb-4 rounded">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="imageScale" class="form-label">图片缩放比例: <span id="scaleValue">1.5</span>x</label>
                                <input type="range" class="form-range custom-range" id="imageScale" min="0.5" max="3" step="0.1"
                                    value="1.5">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="imageFormat" class="form-label">图片格式</label>
                                <select class="form-select" id="imageFormat">
                                    <option value="png">PNG</option>
                                    <option value="jpeg">JPEG</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                <button id="convertToImageBtn" class="btn btn-info" disabled>转换首页为图片</button>
                <button id="downloadImageBtn" class="btn btn-success ms-2 hidden">下载图片</button>

                <!-- 进度条 -->
                <div id="imageProgressContainer" class="mt-3 hidden">
                    <div class="progress">
                        <div id="imageProgressBar" class="progress-bar" role="progressbar" style="width: 0%;">0%</div>
                    </div>
                </div>

                <!-- 图片预览区域 -->
                <div id="imagePreviewArea" class="pdf-preview-container mt-3 hidden">
                    <h6>首页预览:</h6>
                    <img id="pdfPreviewImage" class="pdf-preview-image" alt="PDF首页预览">
                </div>
            </div>
        </div>

        <!-- 水印设置区域 -->
        <div class="card mb-4">
            <div class="card-header">
                <h5>水印设置</h5>
            </div>
            <div class="card-body">
                <form id="watermarkForm">
                    <input type="hidden" id="uploadedFileName" name="fileName">
                    <input type="hidden" id="selectedFileName" name="selectedFileName">

                    <div class="mb-3">
                        <label for="watermarkText" class="form-label">水印文字</label>
                        <input type="text" class="form-control" id="watermarkText" name="watermarkText"
                            placeholder="请输入水印文字" value="浙江省水利河口研究院（浙江省海洋规划设计研究院）">
                    </div>

                    <div class="border p-3 mb-4 rounded">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="fontSize" class="form-label">字体大小</label>
                                    <input type="range" class="form-range custom-range" id="fontSize" name="fontSize"
                                        min="10" max="100" value="20">
                                    <span id="fontSizeValue">20</span>px
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="opacity" class="form-label">透明度</label>
                                    <input type="range" class="form-range custom-range" id="opacity" name="opacity" min="0"
                                        max="100" value="30">
                                    <span id="opacityValue">30</span>%
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="fontColor" class="form-label">字体颜色</label>
                                    <input type="color" class="form-control form-control-color" id="fontColor" name="fontColor"
                                        value="#C2BFBC">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="border p-3 mb-4 rounded">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="position" class="form-label">水印位置</label>
                                    <select class="form-select" id="position" name="position">
                                        <option value="diagonal">对角线</option>
                                        <option value="center">居中</option>
                                        <option value="tile">平铺</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="fontWeight" class="form-label">字体粗细</label>
                                    <select class="form-select" id="fontWeight" name="fontWeight">
                                        <option value="bold">粗体</option>
                                        <option value="normal">正常</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="startPage" class="form-label">水印起始页</label>
                                    <select class="form-select" id="startPage" name="startPage">
                                        <option value="1">第1页</option>
                                        <option value="2" selected>第2页</option>
                                        <option value="3">第3页</option>
                                        <option value="4">第4页</option>
                                        <option value="5">第5页</option>
                                        <option value="0">所有页</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <button type="button" class="btn btn-info me-2" id="previewWatermark" disabled>水印预览</button>
                    <button type="submit" class="btn btn-success" id="applyWatermark" disabled>应用水印</button>
                </form>

                <!-- 进度条 -->
                <div id="progressContainer" class="mt-3" style="display: none;">
                    <div class="progress">
                        <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%;">0%</div>
                    </div>
                    <div id="progressText" class="mt-2 text-center"></div>
                </div>
            </div>
        </div>

        <!-- 预览和下载区域 -->
        <div class="card">
            <div class="card-header">
                <h5>预览和下载</h5>
            </div>
            <div class="card-body">
                <div id="previewArea" class="mb-3">
                    <p>上传文件后将在此处显示预览。</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 删除确认模态框 -->
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">确认删除</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>确定要删除文件 <strong id="deleteFileName"></strong> 吗？</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">删除</button>
                </div>
            </div>
        </div>
    </div>


    <script src="js/bootstrap.bundle.min.js"></script>
    <script src="js/axios.min.js"></script>
    <script>
        // 设置PDF.js worker路径 https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = './js/pdf.worker.min.js';

        // 全局变量
        let fileToDelete = null;
        let eventSource = null; // 用于存储EventSource连接

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function () {
            // 加载文件列表
            loadFileList();

            // 绑定字体大小滑块事件
            document.getElementById('fontSize').addEventListener('input', function () {
                document.getElementById('fontSizeValue').textContent = this.value;
            });

            // 绑定透明度滑块事件
            document.getElementById('opacity').addEventListener('input', function () {
                document.getElementById('opacityValue').textContent = this.value;
            });

            // PDF转图片功能相关事件绑定
            document.getElementById('convertToImageBtn').addEventListener('click', convertPdfToImage);
            document.getElementById('downloadImageBtn').addEventListener('click', downloadConvertedImage);
            document.getElementById('imageScale').addEventListener('input', updateScaleValue);
        });

        // 更新缩放值显示
        function updateScaleValue() {
            document.getElementById('scaleValue').textContent = document.getElementById('imageScale').value;
        }

        // 转换PDF为图片
        async function convertPdfToImage() {
            const fileName = document.getElementById('selectedFileName').value;

            if (!fileName) {
                alert('请先选择一个已上传的PDF文件');
                return;
            }

            try {
                // 显示进度条
                document.getElementById('imageProgressContainer').classList.remove('hidden');
                updateImageProgress(0, '正在加载PDF...');

                // 构建文件路径
                const pdfUrl = `/uploads/${encodeURIComponent(fileName)}`;

                // 获取PDF文件内容
                const response = await fetch(pdfUrl);
                if (!response.ok) {
                    throw new Error(`无法获取PDF文件: ${response.status} ${response.statusText}`);
                }

                const arrayBuffer = await response.arrayBuffer();

                updateImageProgress(20, '正在解析PDF...');

                const pdfDoc = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

                updateImageProgress(40, '正在渲染首页...');

                // 获取第一页
                const page = await pdfDoc.getPage(1);
                const scale = parseFloat(document.getElementById('imageScale').value);
                const viewport = page.getViewport({ scale });

                // 创建canvas
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.height = viewport.height;
                canvas.width = viewport.width;

                // 渲染页面
                const renderContext = {
                    canvasContext: context,
                    viewport: viewport
                };

                await page.render(renderContext).promise;

                updateImageProgress(80, '正在生成图片...');

                // 转换为图片
                const format = document.getElementById('imageFormat').value;
                const mimeType = format === 'png' ? 'image/png' : 'image/jpeg';
                const dataUrl = canvas.toDataURL(mimeType);

                // 显示预览
                const previewImage = document.getElementById('pdfPreviewImage');
                previewImage.src = dataUrl;
                previewImage.alt = `PDF首页预览 (${format.toUpperCase()})`;
                document.getElementById('imagePreviewArea').classList.remove('hidden');

                // 保存图片数据到全局变量以便下载
                window.convertedImageDataUrl = dataUrl;
                window.convertedImageFormat = format;
                window.currentPdfToImageFileName = fileName;

                // 启用下载按钮
                document.getElementById('downloadImageBtn').classList.remove('hidden');

                updateImageProgress(100, '转换完成');

                // 3秒后隐藏进度条
                setTimeout(() => {
                    document.getElementById('imageProgressContainer').classList.add('hidden');
                }, 3000);
            } catch (error) {
                console.error('PDF处理错误:', error);
                alert('PDF处理错误: ' + error.message);
                document.getElementById('imageProgressContainer').classList.add('hidden');
            }
        }

        // 更新图片转换进度
        function updateImageProgress(percent, text) {
            const progressBar = document.getElementById('imageProgressBar');
            progressBar.style.width = percent + '%';
            progressBar.textContent = percent + '%';
            if (text) {
                progressBar.setAttribute('aria-valuenow', percent);
            }
        }

        // 下载转换后的图片
        function downloadConvertedImage() {
            if (!window.convertedImageDataUrl) {
                alert('没有可下载的图片');
                return;
            }

            // 创建下载链接
            const link = document.createElement('a');
            link.href = window.convertedImageDataUrl;

            // 使用原始PDF文件名，替换扩展名为图片格式
            let originalFileName = 'pdf-first-page';
            if (window.currentPdfToImageFileName) {
                originalFileName = window.currentPdfToImageFileName.replace(/\.pdf$/i, '');
            }
            link.download = `${originalFileName}.${window.convertedImageFormat}`;

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // 加载文件列表
        async function loadFileList() {
            try {
                const response = await axios.get('/files');

                if (response.data.success) {
                    displayFileList(response.data.files);
                } else {
                    document.getElementById('fileList').innerHTML = '<p>加载文件列表失败: ' + response.data.message + '</p>';
                }
            } catch (error) {
                console.error('加载错误:', error);
                document.getElementById('fileList').innerHTML = '<p>加载文件列表过程中发生错误</p>';
            }
        }

        // 显示文件列表
        function displayFileList(files) {
            const fileListElement = document.getElementById('fileList');

            if (files.length === 0) {
                fileListElement.innerHTML = '<p>暂无上传文件</p>';
                return;
            }

            let html = '<div class="list-group">';
            files.forEach(file => {
                // 格式化文件大小
                const formattedSize = formatFileSize(file.size);
                // 格式化修改时间
                const formattedDate = new Date(file.modified).toLocaleString();
                // 判断是否为水印文件
                const fileType = file.isWatermarked ? '水印文件' : '原始文件';
                const badgeClass = file.isWatermarked ? 'bg-success' : 'bg-primary';

                // 对文件名进行编码以正确处理中文字符
                const encodedFileName = encodeURIComponent(file.name);

                // 为列表项添加data属性，便于选择操作
                html += `
                    <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center file-item" 
                         data-filename="${encodedFileName}" 
                         data-iswatermarked="${file.isWatermarked}">
                        <div>
                            <div class="fw-bold">${file.name}</div>
                            <small class="text-muted">${formattedDate} • ${formattedSize}</small>
                        </div>
                        <div>
                            <span class="badge ${badgeClass} me-2">${fileType}</span>
                            <button class="btn btn-sm btn-outline-primary preview-btn me-2" data-filename="${encodedFileName}">预览</button>
                            <button class="btn btn-sm btn-outline-danger delete-btn me-2" data-filename="${encodedFileName}">删除</button>
                            ${file.isWatermarked ?
                        '<button class="btn btn-sm btn-secondary" disabled>已添加水印</button>' +
                        '<a href="/uploads/' + file.name + '" download="' + simplifyFileName(file.name) + '" class="btn btn-sm btn-outline-primary ms-2">下载</a>' :
                        '<button class="btn btn-sm btn-outline-success select-btn" data-filename="' + encodedFileName + '">选择</button>'}
                        </div>
                    </div>
                `;
            });
            html += '</div>';

            fileListElement.innerHTML = html;

            // 为预览按钮添加事件监听器
            document.querySelectorAll('.preview-btn').forEach(button => {
                button.addEventListener('click', function () {
                    const fileName = decodeURIComponent(this.getAttribute('data-filename'));
                    showPreview(fileName);
                });
            });

            // 为选择按钮添加事件监听器
            document.querySelectorAll('.select-btn').forEach(button => {
                button.addEventListener('click', function () {
                    const fileName = decodeURIComponent(this.getAttribute('data-filename'));
                    selectFile(fileName);
                });
            });

            // 为删除按钮添加事件监听器
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', function () {
                    const fileName = decodeURIComponent(this.getAttribute('data-filename'));
                    showDeleteConfirm(fileName);
                });
            });
        }

        // 简化文件名，去除多余信息，只保留核心名称部分
        function simplifyFileName(fileName) {
            // 如果是水印文件，去除前缀和时间戳，只保留原始文件名，并添加WM后缀
            if (fileName.startsWith('watermarked-')) {
                // 匹配模式: watermarked-{timestamp}-{originalFileName}
                const match = fileName.match(/^watermarked-\d+-(.+)$/);
                if (match && match[1]) {
                    const originalFileName = match[1];
                    // 在文件名（不含扩展名）后添加WM
                    const lastDotIndex = originalFileName.lastIndexOf('.');
                    if (lastDotIndex > 0) {
                        const nameWithoutExt = originalFileName.substring(0, lastDotIndex);
                        const ext = originalFileName.substring(lastDotIndex);
                        return `${nameWithoutExt}WM${ext}`;
                    } else {
                        // 如果没有扩展名，直接添加WM
                        return `${originalFileName}WM`;
                    }
                }
            }

            // 对于非水印文件，直接返回原文件名
            return fileName;
        }

        // 格式化文件大小
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';

            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));

            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // 选择文件
        function selectFile(fileName) {
            // 移除之前选中文件的高亮
            document.querySelectorAll('.file-item').forEach(item => {
                item.classList.remove('active');
            });

            // 为选中的文件添加高亮
            const selectedItem = document.querySelector(`.file-item[data-filename="${encodeURIComponent(fileName)}"]`);
            if (selectedItem) {
                selectedItem.classList.add('active');
            }

            // 保存选中的文件名到隐藏字段
            document.getElementById('selectedFileName').value = fileName;

            // 启用水印预览和应用按钮
            document.getElementById('previewWatermark').disabled = false;
            document.getElementById('applyWatermark').disabled = false;

            // 同时启用PDF转图片按钮
            document.getElementById('convertToImageBtn').disabled = false;

            // 保存原始文件名用于图片下载
            window.currentPdfToImageFileName = fileName;

            console.log('已选择文件:', fileName);
        }

        // 显示预览
        function showPreview(fileName) {
            // 直接在预览区域显示PDF
            const previewArea = document.getElementById('previewArea');
            previewArea.innerHTML = `
                <iframe src="/preview/${encodeURIComponent(fileName)}" width="100%" height="600px" style="border: 1px solid #ddd;"></iframe>
                <div class="mt-2">
                    <a href="/preview/${encodeURIComponent(fileName)}" download="${simplifyFileName(fileName)}" class="btn btn-primary">下载文件</a>
                </div>
            `;

            // 滚动到预览区域
            previewArea.scrollIntoView({ behavior: 'smooth' });
        }

        // 显示删除确认对话框
        function showDeleteConfirm(fileName) {
            fileToDelete = fileName;
            document.getElementById('deleteFileName').textContent = fileName;

            const modal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
            modal.show();
        }

        // 确认删除文件
        document.getElementById('confirmDeleteBtn').addEventListener('click', async function () {
            if (!fileToDelete) return;

            try {
                const response = await axios.delete(`/delete/${encodeURIComponent(fileToDelete)}`);

                if (response.data.success) {
                    alert('文件删除成功');
                    // 关闭模态框
                    const modal = bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal'));
                    modal.hide();
                    // 重新加载文件列表
                    await loadFileList();
                    // 如果删除的是选中的文件，清除选择
                    if (document.getElementById('selectedFileName').value === fileToDelete) {
                        document.getElementById('selectedFileName').value = '';
                        document.getElementById('previewWatermark').disabled = true;
                        document.getElementById('applyWatermark').disabled = true;
                        document.getElementById('convertToImageBtn').disabled = true; // 同时禁用PDF转图片按钮
                    }
                } else {
                    alert('文件删除失败: ' + response.data.message);
                }
            } catch (error) {
                console.error('删除错误:', error);
                alert('文件删除过程中发生错误: ' + error.message);
            }

            fileToDelete = null;
        });

        // 文件上传处理
        document.getElementById('uploadForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const formData = new FormData();
            const pdfFile = document.getElementById('pdfFile').files[0];

            if (!pdfFile) {
                alert('请选择一个PDF文件');
                return;
            }

            formData.append('pdfFile', pdfFile);

            try {
                // 使用相对路径而不是硬编码端口
                const response = await axios.post('/upload', formData, {
                    headers: {
                        'Content-Type': 'multipart/form-data'
                    }
                });

                if (response.data.success) {
                    alert('文件上传成功');
                    // 重新加载文件列表
                    await loadFileList();
                } else {
                    alert('文件上传失败: ' + response.data.message);
                }
            } catch (error) {
                console.error('上传错误:', error);
                if (error.response && error.response.data && error.response.data.message) {
                    alert('文件上传过程中发生错误: ' + error.response.data.message);
                } else {
                    alert('文件上传过程中发生错误');
                }
            }
        });

        // 显示进度条
        function showProgress() {
            document.getElementById('progressContainer').style.display = 'block';
            updateProgress(0, '开始处理...');
        }

        // 更新进度条
        function updateProgress(percent, text) {
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');

            progressBar.style.width = percent + '%';
            progressBar.textContent = percent + '%';
            progressText.textContent = text;
        }

        // 隐藏进度条
        function hideProgress() {
            document.getElementById('progressContainer').style.display = 'none';
        }

        // 水印预览处理（带进度）
        document.getElementById('previewWatermark').addEventListener('click', function (e) {
            e.preventDefault();

            // 获取选中的文件名
            const fileName = document.getElementById('selectedFileName').value;

            if (!fileName) {
                alert('请先选择一个文件');
                return;
            }

            // 获取水印设置
            const watermarkParams = new URLSearchParams({
                fileName: fileName,
                text: document.getElementById('watermarkText').value,
                fontSize: document.getElementById('fontSize').value,
                opacity: document.getElementById('opacity').value,
                fontColor: document.getElementById('fontColor').value,
                position: document.getElementById('position').value,
                fontWeight: document.getElementById('fontWeight').value,
                startPage: document.getElementById('startPage').value
            });

            // 显示进度条
            showProgress();

            // 关闭之前的EventSource连接（如果存在）
            if (eventSource) {
                eventSource.close();
            }

            // 创建新的EventSource连接
            eventSource = new EventSource(`/preview-watermark-progress?${watermarkParams}`);

            let receivedBuffer = null;
            let receivedLength = 0;
            //  console.log('EventSource connected');
            eventSource.onmessage = function (event) {
                try {
                    const data = JSON.parse(event.data);

                    switch (data.type) {
                        case 'init':
                            updateProgress(0, '初始化处理...');
                            break;
                        case 'start':
                            updateProgress(10, `开始处理，共${data.totalPages}页...`);
                            break;
                        case 'progress':
                            const progress = 10 + Math.round(data.progress * 0.8); // 10%到90%之间
                            updateProgress(progress, `正在处理第${data.currentPage}/${data.totalPages}页...`);
                            break;
                        case 'saving':
                            updateProgress(90, '正在保存文件...');
                            break;
                        case 'preview_complete':
                            updateProgress(95, '预览准备完成...');
                            // 初始化缓冲区
                            receivedBuffer = new Uint8Array(data.bufferLength);
                            receivedLength = 0;
                            break;
                        case 'chunk':
                            // 存储接收到的数据块
                            if (receivedBuffer) {
                                const binaryData = atob(data.data);
                                const startIndex = data.index;

                                // 将二进制数据写入缓冲区
                                for (let i = 0; i < binaryData.length; i++) {
                                    receivedBuffer[startIndex + i] = binaryData.charCodeAt(i);
                                }

                                // 更新已接收长度
                                receivedLength = Math.max(receivedLength, startIndex + binaryData.length);
                            }
                            break;
                        case 'end':
                            // 所有数据接收完毕，显示PDF
                            updateProgress(100, '处理完成，正在生成预览...');

                            if (receivedBuffer) {
                                try {
                                    // 创建Blob并在预览区域显示
                                    const blob = new Blob([receivedBuffer.slice(0, receivedLength)], { type: 'application/pdf' });
                                    const url = URL.createObjectURL(blob);

                                    // 在预览区域显示PDF
                                    const previewArea = document.getElementById('previewArea');
                                    previewArea.innerHTML = `
                                        <iframe src="${url}" width="100%" height="600px" style="border: 1px solid #ddd;"></iframe>
                                        <div class="mt-2">
                                            <a href="${url}" download="watermark-preview.pdf" class="btn btn-primary">下载预览文件</a>
                                        </div>
                                    `;

                                    // 滚动到预览区域
                                    previewArea.scrollIntoView({ behavior: 'smooth' });
                                } catch (previewError) {
                                    console.error('生成预览时出错:', previewError);
                                    const previewArea = document.getElementById('previewArea');
                                    previewArea.innerHTML = `<p class="text-danger">生成预览时出错: ${previewError.message}</p>`;
                                }
                            } else {
                                const previewArea = document.getElementById('previewArea');
                                previewArea.innerHTML = '<p class="text-danger">未接收到有效的预览数据</p>';
                            }

                            // 清理
                            receivedBuffer = null;
                            receivedLength = 0;

                            // 隐藏进度条
                            setTimeout(hideProgress, 1000);

                            // 关闭连接
                            eventSource.close();
                            break;
                        case 'error':
                            updateProgress(0, '处理出错: ' + data.message);
                            alert('水印预览过程中发生错误: ' + data.message);
                            hideProgress();
                            eventSource.close();
                            receivedBuffer = null;
                            receivedLength = 0;
                            break;
                    }
                } catch (parseError) {
                    console.error('解析SSE消息时出错:', parseError);
                    console.error('原始数据:', event.data);
                }
            };

            eventSource.onerror = function (err) {
                console.error('SSE连接错误:', err);
                updateProgress(0, '连接错误');
                alert('与服务器的连接出现错误');
                hideProgress();
                eventSource.close();
                receivedBuffer = null;
                receivedLength = 0;
            };
        });

        // 应用水印处理（带进度）
        document.getElementById('watermarkForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            // 获取选中的文件名
            const fileName = document.getElementById('selectedFileName').value;

            if (!fileName) {
                alert('请先选择一个文件');
                return;
            }

            // 检查文件是否已经是水印文件
            const selectedItem = document.querySelector(`.file-item[data-filename="${encodeURIComponent(fileName)}"]`);
            if (selectedItem && selectedItem.getAttribute('data-iswatermarked') === 'true') {
                alert('该文件已经是水印文件，无法再次添加水印');
                return;
            }

            // 获取水印设置
            const watermarkParams = new URLSearchParams({
                fileName: fileName,
                text: document.getElementById('watermarkText').value,
                fontSize: document.getElementById('fontSize').value,
                opacity: document.getElementById('opacity').value,
                fontColor: document.getElementById('fontColor').value,
                position: document.getElementById('position').value,
                fontWeight: document.getElementById('fontWeight').value,
                startPage: document.getElementById('startPage').value
            });

            // 显示进度条
            showProgress();

            // 关闭之前的EventSource连接（如果存在）
            if (eventSource) {
                eventSource.close();
            }

            // 创建新的EventSource连接
            eventSource = new EventSource(`/watermark-progress?${watermarkParams}`);

            eventSource.onmessage = function (event) {
                try {
                    const data = JSON.parse(event.data);

                    switch (data.type) {
                        case 'init':
                            updateProgress(0, '初始化处理...');
                            break;
                        case 'start':
                            updateProgress(10, `开始处理，共${data.totalPages}页...`);
                            break;
                        case 'progress':
                            const progress = 10 + Math.round(data.progress * 0.8); // 10%到90%之间
                            updateProgress(progress, `正在处理第${data.currentPage}/${data.totalPages}页...`);
                            break;
                        case 'saving':
                            updateProgress(90, '正在保存文件...');
                            break;
                        case 'complete':
                            updateProgress(100, '处理完成');


                            // 在预览区域显示处理后的PDF
                            const previewArea = document.getElementById('previewArea');
                            previewArea.innerHTML = `
                                <iframe src="/uploads/${data.fileName}" width="100%" height="600px" style="border: 1px solid #ddd;"></iframe>
                                <div class="mt-2">
                                    <a href="/uploads/${data.fileName}" download="${simplifyFileName(data.fileName)}" class="btn btn-primary">下载处理后的PDF</a>
                                </div>
                            `;

                            // 重新加载文件列表
                            setTimeout(loadFileList, 500);

                            // 清除选中的文件
                            document.getElementById('selectedFileName').value = '';
                            document.getElementById('previewWatermark').disabled = true;
                            document.getElementById('applyWatermark').disabled = true;

                            // 隐藏进度条
                            setTimeout(hideProgress, 1000);

                            // 关闭连接
                            eventSource.close();
                            break;
                        case 'result':
                            if (data.data.success) {
                                updateProgress(100, '处理完成');


                                // 在预览区域显示处理后的PDF
                                const previewArea = document.getElementById('previewArea');
                                previewArea.innerHTML = `
                                    <iframe src="${data.data.downloadUrl}" width="100%" height="600px" style="border: 1px solid #ddd;"></iframe>
                                    <div class="mt-2">
                                        <a href="${data.data.downloadUrl}" download class="btn btn-primary">下载处理后的PDF</a>
                                    </div>
                                `;

                                // 重新加载文件列表
                                setTimeout(loadFileList, 500);

                                // 清除选中的文件
                                document.getElementById('selectedFileName').value = '';
                                document.getElementById('previewWatermark').disabled = true;
                                document.getElementById('applyWatermark').disabled = true;
                            } else {
                                updateProgress(0, '处理失败: ' + data.data.message);
                                alert('水印应用失败: ' + data.data.message);
                            }

                            // 隐藏进度条
                            setTimeout(hideProgress, 1000);

                            // 关闭连接
                            eventSource.close();
                            break;
                        case 'error':
                            updateProgress(0, '处理出错: ' + data.message);
                            alert('水印应用过程中发生错误: ' + data.message);
                            hideProgress();
                            eventSource.close();
                            break;
                    }
                } catch (parseError) {
                    console.error('解析SSE消息时出错:', parseError);
                }
            };

            eventSource.onerror = function (err) {
                console.error('SSE连接错误:', err);
                updateProgress(0, '连接错误');
                alert('与服务器的连接出现错误');
                hideProgress();
                eventSource.close();
            };
        });
    </script>
</body>

</html>